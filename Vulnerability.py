from enum import Enum
import datetime
from VulnerableRepository import VulnerableRepository
from Severity import Severity


class TicketStatus(Enum):
    UNDETERMINED = 1
    NO_TICKET = 2
    TICKET_EXISTS = 3

class Vulnerability:
    repositories: dict # repository name to VulnerableRepository, e.g.badgepassetsservice
    severity: Severity # keep most severe seen across repos
    name: str
    ticket_status: TicketStatus

    def __repr__(self):
        return f'{self.name} severity:{self.severity} \n {self.repositories} '

    def __init__(self, name:str, severity:Severity, repository_name:str, image_pushed_at, image_id ):
        self.repositories = {repository_name: VulnerableRepository(severity, repository_name, image_pushed_at, image_id)}
        self.name = name
        self.severity = severity
        self.ticket_status = TicketStatus.UNDETERMINED

    def append(self, severity:Severity, repo_name:str, image_pushed_at, image_id):
        if severity < self.severity:
            self.severity = severity

        if repo_name not in self.repositories:
            self.repositories[repo_name] = VulnerableRepository(severity,repo_name, image_pushed_at,image_id )
        else: # a vulnerability can show multiple times on same image
            self.repositories[repo_name].keep_highest_severity(severity)

        return self


    def comment_ticket(self, jira, ticket_name, dry_run):
        if dry_run:
            print(f'DRY RUN, not actually commenting on {ticket_name}')
        else:
            print(f'Commenting on {ticket_name}')
            jira.add_comment(ticket_name, self.default_adf_body())

    def ticket_description(self):
        amazon_link_attempt = f'https://explore.alas.aws.amazon.com/{self.name.upper()}.html'
        nist_link_attempt = f'https://nvd.nist.gov/vuln/detail/{self.name}'
        links =[]
        if self.name.upper().startswith('CVE'):
            links = [amazon_link_attempt, nist_link_attempt]
        elif self.name.upper().startswith('ALAS'):
            links = [amazon_link_attempt, nist_link_attempt]

        return self.ticket_body_with_links(links)

    def jira_priority_of_severity(self):
        match self.severity:
            case Severity.LOW:
                return 'P4 - Trivial'
            case Severity.MEDIUM:
                return 'P3 - Minor'
            case Severity.HIGH:
                return 'P2 - Major'
            case Severity.CRITICAL:
                return 'P1 - Critical'


    def due_date_for_severity(self):
        days_away = {
            Severity.CRITICAL: 3,
            Severity.HIGH: 7,
            Severity.MEDIUM: 21,
            Severity.LOW: 56,
        }.get(self.severity)

        return datetime.date.today() + datetime.timedelta(days_away)

    def create_issue(self):
        return {
            'project': {'key': 'MEM'},
            'summary': self.name,
            'description': self.ticket_description(),
            'issuetype': {'name': 'Story'},
            'labels': ['Vulnerability'],
            # the underlying priority id value could be preferable than using name, but unsure how to legitimately get it, outside of debugger peeking
            'priority': {'name': self.jira_priority_of_severity()},
            'parent': {'key': '<your jira parent here>'},
            'duedate': self.due_date_for_severity().strftime('%Y-%m-%d'),
            # attempts to set status get error Field 'status' cannot be set. It is not on the appropriate screen, or unknown."
        }

    # atlassian document format https://developer.atlassian.com/cloud/jira/platform/apis/document/structure/
    def default_adf_body(self):
        return {
            "type": "doc",
            "version": 1,
            "content": [
                {
                    "type": "paragraph",
                    "content": [
                        {
                            "type": "text",
                            "text": f'{self}'
                        }
                    ]
                }
            ]
        }

    def ticket_body_with_links(self, links):
        body = self.default_adf_body()
        for link in links:
            body['content'][0]['content'].append({
                    "type": "text",
                    "text": f' {link} ',
                    "marks": [
                        {
                            "type": "link",
                            "attrs": {
                                "href": link
                            }
                        }
                    ]
            })
        return body


